/*
 * ocarina-tabs | ♪♫ | 0.0.3 | ♫♪ | 2014-12-28
 * https://github.com/simeydotme/ocarina-tabs
 * Licenced (MIT) 2014 | ♪ | Simon Goellner;
 */
var pubsub=$({}),app=function(a){return a.templates={},a.$={},a.$.doc=$(document),a.$.window=$(window),a.$.body=$("body"),a.$.title=$(".stage__title"),a.$.score=$(".stage__score"),a.$.piano=$(".input-piano"),a.$.pianoOcarina=$(".input-area .note"),a.$.pianoKeys=a.$.piano.find(".key"),a.$.titleTemplate=$("#title-template"),a.$.noteTemplate=$("#note-template"),a}(app||{}),app=function(a){var b=function(){setTimeout(function(){var a=130;app.playNote("5AN"),setTimeout(function(){app.playNote("5GS")},a),setTimeout(function(){app.playNote("5DS")},2*a),setTimeout(function(){app.playNote("4BN")},3*a),setTimeout(function(){app.playNote("4AS")},4*a),setTimeout(function(){app.playNote("5DN")},5*a),setTimeout(function(){app.playNote("5FS")},6*a),setTimeout(function(){app.playNote("6CN")},7*a)},1e3)};return a.init=function(){a.model=window.fixture||{notes:[]},a.loadFonts(function(){a._renderSong(a.model)}),b()}(),a}(app||{}),app=function(a){return a.inputArea={},a.$.inputArea=$(".input-area"),a.$.inputAreaHeader=$(".input-header"),a.inputArea.movable=function(){a.$.inputArea.draggable({handle:a.$.inputAreaHeader,containment:a.$.body,appendTo:a.$.body,opacity:.6,create:function(){pubsub.trigger("inputArea.created")},stop:function(){pubsub.trigger("inputArea.finishedDragging")}})},a.inputArea.setCoords=function(){var b,c={};c.x=parseInt(a.$.inputArea.css("left").replace("px","")),c.y=parseInt(a.$.inputArea.css("top").replace("px","")),b=JSON.stringify(c),localStorage.setItem("inputCoords",b)},a.inputArea.getDimensions=function(){var b,c,d,e;return c=localStorage.getItem("inputCoords",c),b=JSON.parse(c)||{x:9999,y:9999},d={w:a.$.window.width(),h:a.$.window.height()},e={w:a.$.inputArea.width(),h:a.$.inputArea.height()},d.w<b.x+e.w&&(b.x=d.w-e.w-30),d.h<b.y+e.h&&(b.y=d.h-e.h-30),{left:b.x,top:b.y,width:e.w,height:e.h}},a.inputArea.show=function(){var b=a.$.inputArea,c=a.inputArea.getDimensions();b.velocity({opacity:[1,0],top:[c.top,c.top+30],left:[c.left,c.left],translateZ:0},{duration:800,easing:[500,20],queue:!1,delay:500})},a.inputArea.pubsub=function(){pubsub.on("inputArea.created",a.inputArea.show),pubsub.on("inputArea.finishedDragging",a.inputArea.setCoords)},a.inputArea.init=function(){a.inputArea.pubsub(),a.inputArea.movable()}(),a}(app||{}),app=function(a){return a.interactions={},a.interactions.events=function(){var b=Modernizr.touch?"touchend":"mouseup",c=Modernizr.touch?"touchstart":"mousedown";a.$.score.on(b+".note",".note",a.note.handleMouseup),a.$.doc.on("keyup.note",a.note.handleKeyup),a.$.doc.on("keydown.note",a.note.handleKeydown),a.$.pianoKeys.on("mouseover.key",a.piano.mouseover),a.$.pianoKeys.on("mouseout.key",a.piano.mouseout),a.$.pianoKeys.on(b+".key",a.piano.mouseup),a.$.pianoKeys.on(c+".key",a.piano.mousedown)},a.interactions.init=function(){a.interactions.events()}(),a}(app||{}),app=function(a){return a.note={},a.note.playNote=function(b){var c=!1,d=0;if(!b)return void console.warn("no Note was supplied for playback...");if("string"===$.type(b)){if("undefined"===$.type(app.notes[b]))return void console.error('could find the Note "'+b+'" for playback...');c=b}else b instanceof jQuery&&(c=a.note.getNote(b));c&&(d=app.notes.startTimes[c]||0,app.notes[c].stop().setTime(d).play())},a.note.addNote=function(){var b,c,d=arguments[0],e=a.$.score.find(".note"),f=e.length-1,g=a.track.duration,h=a.track.dot;return"string"!==$.type(d)?void console.warn('Couldnt add note because it wasnt in the string format: "5CN"'):(arguments.length>1&&"number"===$.type(arguments[1])&&(f=arguments[1]>=0?arguments[1]:0),"number"===$.type(arguments[2])?g=arguments[2]:"undefined"!==$.type(arguments[2])&&console.warn("duration argument ("+arguments[2]+") should be a number"),"boolean"===$.type(arguments[3])?h=arguments[3]:"undefined"!==$.type(arguments[3])&&console.warn("dot argument ("+arguments[3]+") should be a boolean"),e.length?f>e.length&&(f=e.length):f=0,b={note:d,duration:g,dot:h},c=$(a._createNotes({notes:[b]})),e.length?(e.eq(f).after(c),a.track.selected=f+1):(a.$.score.append(c),a.track.selected=0),console.info('Adding a "'+a.noteNames[g]+'" note ('+d+") at index ["+(f+1)+"]"),pubsub.trigger("track.selectNote"),pubsub.trigger("track.createNotesModel"),a.note.showNote(c),b)},a.note.removeNote=function(b,c){var d,e=a.$.score.find(".note"),f=e.length-1;if(c&&"forward"===c||(c="back"),"undefined"!==$.type(b)){if("number"!==$.type(b))return void console.warn("Couldnt remove note, incorrectly supplied index")}else b=a.track.selected;return"forward"===c&&b>=f&&(b=f),a.track.selected=0===b?0:"forward"!==c||"forward"===c&&b>=f?b-1:b,d=e.eq(b),a.note.hideNote(d),pubsub.trigger("track.selectNote"),console.info("Removing note ("+d.attr("class")+") at index ["+b+"]"),a.model.notes},a.note.setLength=function(b,c,d){if("number"!==$.type(b)||"number"!==$.type(c)||"boolean"!==$.type(d))return console.warn("Couldn't change length, no length/note-index was supplied"),!1;{var e=a.$.score.find(".note"),f=e.eq(b),g=a.note.getLengthClass(f);a.note.getLength(f)}f.removeClass(g).removeClass("note--dot").addClass("note--♫"+c),d&&f.addClass("note--dot"),a.track.duration=c,a.track.dot=d,pubsub.trigger("track.createNotesModel")},a.note.changeLength=function(b,c){var d=a.note.getLength(b),e=a.note.getIndex(b),f=a.note.isDot(b),g=!f,h=d;c=c||"faster";for(var i in app.noteLengths)app.noteLengths[i]===d&&("faster"!==c||f?"slower"===c&&f&&("undefined"!=typeof app.noteLengths[parseInt(i)-1]?h=app.noteLengths[parseInt(i)-1]:g=f):"undefined"!=typeof app.noteLengths[parseInt(i)+1]?h=app.noteLengths[parseInt(i)+1]:g=f);a.note.setLength(e,h,g)},a.note.getLengthClass=function(a){var b=/note--♫[0-9]{1,2}/,c=a.attr("class").match(b)[0];return c},a.note.getLength=function(a){var b=app.note.getLengthClass(a).replace("note--♫",""),c=parseInt(b,10);return c},a.note.getNoteClass=function(a){var b=/note--♪(([4-6]{1}[A-G]{1}[FNS])|(PAUSE)|(BAR)|(RETURN))/,c=a.attr("class").match(b)[0];return c},a.note.getNote=function(a){var b=app.note.getNoteClass(a).replace("note--♪","");return b},a.note.isDot=function(a){return a.hasClass("note--dot")},a.note.getIndex=function(b){var c=a.$.score.find(".note");return c.index(b)},a.note.getSelectedNote=function(){var b=a.$.score.find(".note"),c=b.eq(a.track.selected);return c},a.note.showNote=function(a){var b=a.css("margin-right"),c=a.css("width"),d=a.find(".note__tab");a.css({transition:"none",opacity:0}).velocity({width:[c,0],marginRight:[b,0]},{queue:!1,duration:230}).velocity({opacity:1},{queue:!1,duration:100,delay:130,complete:function(a){$(a).attr("style","")}}),d.velocity({translateY:"18px"},0).velocity({translateY:0},{duration:500,delay:180,easing:[1200,30]})},a.note.hideNote=function(b){var c=(a.$.score.find(".note"),b.find(".note__tab"));b.velocity({opacity:0},{queue:!1,duration:200,easing:"easeInOutSine"}),c.velocity({translateY:30},{duration:200,easing:"easeOut"}),b.css("transition","none").velocity({width:0},{queue:!1,duration:200,delay:150,complete:function(a){$(a).remove(),pubsub.trigger("track.createNotesModel"),pubsub.trigger("track.selectNote")}})},a.note.handleKeydown=function(b){var c=b.which,d=a._keymap,e=$(b.target),f=a.note.getSelectedNote();if(!e.is(":input")&&"true"!==e.prop("contenteditable")){for(var g in d)c===d[g]&&(b.preventDefault(),console.info("pressed key "+d[g]));switch(c){case d.up:a.note.changeLength(f,"slower");break;case d.down:a.note.changeLength(f,"faster");break;case d.left:pubsub.trigger("track.selectPreviousNote");break;case d.right:pubsub.trigger("track.selectNextNote")}}},a.note.handleKeyup=function(b){var c=b.which,d=a._keymap,e=$(b.target),f=a.note.getSelectedNote();if(!e.is(":input")&&"true"!==e.prop("contenteditable"))switch(c){case d.backspace:a.note.removeNote(a.track.selected),b.preventDefault();break;case d.delete:a.note.removeNote(a.track.selected,"forward"),b.preventDefault();break;case d.left:a.note.playNote(f);break;case d.right:a.note.playNote(f)}},a.note.handleMouseup=function(){var b=a.$.score.find(".note"),c=$(this);a.track.selected=b.index(c),a.note.playNote(c),pubsub.trigger("track.selectNote")},a.note.events=function(){},a.note.init=function(){a.note.events()}(),a}(app||{}),app=function(a){return a.noteLengths=[1,2,4,8,16,32],a.noteNames={1:"breve",2:"semibreve",4:"crotchet",8:"quaver",16:"semiquaver",32:"demisemiquaver"},a.registerSounds=function(a){var b,c="src/audio/ocarina",d=!0,e=!1,f={};return"piano"===a&&(c="src/audio/piano",f={"4AN":.8,"4AS":.31,"4BF":.31,"4BN":.64,"5CN":.62,"5CS":.6,"5DF":.6,"5DN":.74,"5DS":.6,"5EF":.6,"5EN":.76,"5FN":.64,"5FS":.42,"5GF":.42,"5GN":.7,"5GS":.6,"5AF":.6,"5AN":.3,"5AS":.5,"5BF":.5,"5BN":.55,"6CN":.27,"6CS":.7,"6DF":.7,"6DN":.42,"6DS":.7,"6EF":.7,"6EN":.7,"6FN":.8}),b={"4AN":new buzz.sound(c+"/4AN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"4AS":new buzz.sound(c+"/4AS",{formats:["ogg","mp3"],preload:d,autoplay:e}),"4BF":new buzz.sound(c+"/4BF",{formats:["ogg","mp3"],preload:d,autoplay:e}),"4BN":new buzz.sound(c+"/4BN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5CN":new buzz.sound(c+"/5CN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5CS":new buzz.sound(c+"/5CS",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5DF":new buzz.sound(c+"/5DF",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5DN":new buzz.sound(c+"/5DN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5DS":new buzz.sound(c+"/5DS",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5EF":new buzz.sound(c+"/5EF",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5EN":new buzz.sound(c+"/5EN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5FN":new buzz.sound(c+"/5FN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5FS":new buzz.sound(c+"/5FS",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5GF":new buzz.sound(c+"/5GF",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5GN":new buzz.sound(c+"/5GN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5GS":new buzz.sound(c+"/5GS",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5AF":new buzz.sound(c+"/5AF",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5AN":new buzz.sound(c+"/5AN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5AS":new buzz.sound(c+"/5AS",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5BF":new buzz.sound(c+"/5BF",{formats:["ogg","mp3"],preload:d,autoplay:e}),"5BN":new buzz.sound(c+"/5BN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"6CN":new buzz.sound(c+"/6CN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"6CS":new buzz.sound(c+"/6CS",{formats:["ogg","mp3"],preload:d,autoplay:e}),"6DF":new buzz.sound(c+"/6DF",{formats:["ogg","mp3"],preload:d,autoplay:e}),"6DN":new buzz.sound(c+"/6DN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"6DS":new buzz.sound(c+"/6DS",{formats:["ogg","mp3"],preload:d,autoplay:e}),"6EF":new buzz.sound(c+"/6EF",{formats:["ogg","mp3"],preload:d,autoplay:e}),"6EN":new buzz.sound(c+"/6EN",{formats:["ogg","mp3"],preload:d,autoplay:e}),"6FN":new buzz.sound(c+"/6FN",{formats:["ogg","mp3"],preload:d,autoplay:e}),PAUSE:new buzz.sound(c+"/5CN",{formats:["ogg","mp3"],preload:d,autoplay:e,volume:0}),startTimes:f}},a.notes=a.registerSounds(""),a}(app||{}),app=function(a){return a.piano={},a.piano.highlightKey=function(){var b=$(this),c=b.data("key");b.addClass("key--active"),a.$.pianoOcarina.addClass("note--♪"+c)},a.piano.dimKeys=function(){a.$.pianoKeys.removeClass("key--active"),a.$.pianoOcarina.removeClass(function(a,b){return(b.match(/(^|\s)note--♪\S+/g)||[]).join(" ")})},a.piano.mouseover=function(b){a.piano.dimKeys(),a.piano.highlightKey.call(this,b)},a.piano.mouseout=function(){a.piano.dimKeys()},a.piano.mousedown=function(){a.note.playNote($(this).data("key")),a.$.pianoKeys.on("mouseover.mousedown",a.piano.mousedownover)},a.piano.mousedownover=function(){a.note.playNote($(this).data("key"))},a.piano.mouseup=function(){a.$.pianoKeys.off("mouseover.mousedown"),a.note.addNote($(this).data("key"),a.track.selected)},a.piano.events=function(){},a.piano.init=function(){a.piano.events()}(),a}(app||{}),app=function(a){return a.templates={},a.templates.title=Handlebars.compile(a.$.titleTemplate.html()),a.templates.note=Handlebars.compile(a.$.noteTemplate.html()),a}(app||{}),app=function(a){return a.track={},a.track.selected=0,a.track.duration=4,a.track.dot=!1,a.track.selectNote=function(){var b=a.track.selected;a.$.score.find(".note--selected").removeClass("note--selected"),a.$.score.find(".note").eq(b).addClass("note--selected")},a.track.selectNextNote=function(){var b=a.$.score.find(".note").length-1,c=a.track.selected;a.track.selected=c+1>b?b:c+1,pubsub.trigger("track.selectNote"),console.info("Selecting new note: ["+a.track.selected+"]")},a.track.selectPreviousNote=function(){var b=0,c=a.track.selected;a.track.selected=b>c-1?b:c-1,pubsub.trigger("track.selectNote"),console.info("Selecting new note: ["+a.track.selected+"]")},a.track.playSong=function(a,b){pubsub.trigger("track.playSong"),pubsub.off("track.playSong");var c,d,e,f=1e3,g=/♫[0-9]{1,2}/,h=$(".stage__score .note");app.track.selected===h.length-1&&(app.track.selected=0),a=a||72,b=b||4;var i=function(){$("body").on("click",".note, .key",function(){clearTimeout(c)}),pubsub.on("track.playSong track.stopSong",function(){clearTimeout(c)}),c=setTimeout(function(){d=$(".stage__score .note").eq(app.track.selected),d.length?(e=parseInt(d.attr("class").match(g)[0].replace("♫",""),10),f=60/a*b/e*1e3,d.hasClass("note--dot")&&(f+=.5*f),console.log(f),app.note.playNote(d),pubsub.trigger("track.selectNote"),app.track.selected+=1,i()):app.track.selected=h.length-1},f)};i()},a.track.stopSong=function(){pubsub.trigger("track.stopSong")},a.track.createNotesModel=function(){var a,b,c,d,e;return e=$(".stage__score .note").map(function(e,f){return a=$(f),d=app.note.isDot(a),c=app.note.getNote(a),b=app.note.getLength(a),{note:c,duration:b,dot:d}}).get(),console.info("Building notes model..."),app.model.notes=e,e},a.track.createTitleModel=function(){var b=a.$.title.children(".title__main").text(),c=a.$.title.children(".title__sub").text();return console.info("Building titles model..."),app.model.title=b,app.model.subtitle=c,{title:b,subtitle:c}},a._createTitle=function(b){return a.templates.title(b)},a._createNotes=function(b){return a.templates.note(b)},a._renderSong=function(b){if(!b)return void console.warn("Cannot create song as there is no supplied data");var c=a._createTitle(b),d=a._createNotes(b);a.$.title.html(c),a.$.score.html(d),a.track.selected=a.$.score.find(".note").length-1,pubsub.trigger("track.showTitle"),pubsub.trigger("track.showNotes"),pubsub.trigger("track.selectNote")},a.track.showTitle=function(){var b=a.$.title.children(".title__main"),c=a.$.title.children(".title__sub"),d=a.$.title.children(".title__author");b.add(c).velocity({transition:"none",opacity:0,translateY:-15,translateZ:0},0),b.velocity({opacity:1,translateY:0},{duration:200,easing:"easeOut"}),c.velocity({opacity:1,translateY:0},{duration:200,easing:"easeOut",delay:100}),d.velocity({opacity:[1,0],translateX:[0,200]},200,"easeOut")},a.track.showNotes=function(){a.$.score.find(".note").velocity("transition.slideRightIn",{stagger:30,display:"inline-block"})},a.track.events=function(){pubsub.on("track.selectNote",a.track.selectNote),pubsub.on("track.selectNextNote",a.track.selectNextNote),pubsub.on("track.selectPreviousNote",a.track.selectPreviousNote),pubsub.on("track.showTitle",a.track.showTitle),pubsub.on("track.showNotes",a.track.showNotes),pubsub.on("track.createNotesModel",a.track.createNotesModel),pubsub.on("track.createTitleModel",a.track.createTitleModel)},a.track.init=function(){a.track.events()}(),a}(app||{}),app=function(a){return a.loadFonts=function(a){WebFontConfig={google:{families:["Lato","IM Fell DW Pica"]},active:function(){a.call()}},function(){var a=document.createElement("script");a.src=("https:"==document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js",a.type="text/javascript",a.async="true";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}()},a}(app||{});